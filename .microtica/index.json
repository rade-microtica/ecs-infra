{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Shared ECS Cluster on EC2 (cluster, capacity provider, IAM, security groups, internal ALB). Apps deploy their own services and reference the shared internal ALB.",
  "Parameters": {
    "InstanceType": {
      "Type": "String",
      "Default": "t3.medium",
      "AllowedValues": [
        "t3.small",
        "t3.medium",
        "t3.large",
        "t3.xlarge",
        "m5.large",
        "m5.xlarge"
      ],
      "Description": "EC2 instance type for ECS cluster"
    },
    "MinSize": {
      "Type": "Number",
      "Default": 1,
      "Description": "Minimum number of EC2 instances in the ECS cluster"
    },
    "MaxSize": {
      "Type": "Number",
      "Default": 3,
      "Description": "Maximum number of EC2 instances in the ECS cluster"
    },
    "DesiredCapacity": {
      "Type": "Number",
      "Default": 2,
      "Description": "Desired number of EC2 instances in the ECS cluster"
    },
    "VpcId": {
      "Type": "AWS::EC2::VPC::Id",
      "Description": "VPC ID where resources will be deployed"
    },
    "PublicSubnet1Id": {
      "Type": "AWS::EC2::Subnet::Id",
      "Description": "First public subnet ID (e.g. for ALBs)"
    },
    "PublicSubnet2Id": {
      "Type": "AWS::EC2::Subnet::Id",
      "Description": "Second public subnet ID (e.g. for ALBs)"
    },
    "PrivateSubnet1Id": {
      "Type": "AWS::EC2::Subnet::Id",
      "Description": "First private subnet ID for ECS tasks and EC2 instances"
    },
    "PrivateSubnet2Id": {
      "Type": "AWS::EC2::Subnet::Id",
      "Description": "Second private subnet ID for ECS tasks and EC2 instances"
    }
  },
  "Resources": {
    "ECSHostSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for ECS EC2 instances",
        "VpcId": {
          "Ref": "VpcId"
        },
        "SecurityGroupIngress": []
      }
    },
    "ECSInstanceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Path": "/",
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role",
          "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
        ]
      }
    },
    "ECSInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [
          {
            "Ref": "ECSInstanceRole"
          }
        ]
      }
    },
    "EnableENITrunkingRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
        ],
        "Policies": [
          {
            "PolicyName": "EnableENITrunkingPolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ecs:PutAccountSetting",
                    "ecs:GetAccountSetting",
                    "ecs:ListAccountSettings"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ]
      }
    },
    "EnableENITrunkingFunction": {
      "Type": "AWS::Lambda::Function",
      "Properties": {
        "Runtime": "python3.11",
        "Handler": "index.handler",
        "Role": {
          "Fn::GetAtt": [
            "EnableENITrunkingRole",
            "Arn"
          ]
        },
        "Timeout": 60,
        "Code": {
          "ZipFile": {
            "Fn::Sub": [
              "import boto3\nimport json\nimport urllib.request\n\ndef send_response(event, context, response_status, response_data):\n    response_body = json.dumps({\n        'Status': response_status,\n        'Reason': 'See the details in CloudWatch Log Stream: ' + context.log_stream_name,\n        'PhysicalResourceId': context.log_stream_name,\n        'StackId': event['StackId'],\n        'RequestId': event['RequestId'],\n        'LogicalResourceId': event['LogicalResourceId'],\n        'Data': response_data\n    }).encode('utf-8')\n    \n    req = urllib.request.Request(event['ResponseURL'], data=response_body, method='PUT')\n    urllib.request.urlopen(req)\n\ndef handler(event, context):\n    ecs = boto3.client('ecs')\n    \n    try:\n        if event['RequestType'] == 'Delete':\n            send_response(event, context, 'SUCCESS', {'Message': 'ENI trunking setting left enabled'})\n            return\n        \n        try:\n            current_settings = ecs.list_account_settings(name='awsvpcTrunking')\n            for setting in current_settings.get('settings', []):\n                if setting.get('value') == 'enabled':\n                    print('ENI trunking is already enabled')\n                    send_response(event, context, 'SUCCESS', {'Message': 'ENI trunking was already enabled'})\n                    return\n        except Exception as check_error:\n            print(f'Could not check current setting: {str(check_error)}')\n        \n        response = ecs.put_account_setting(name='awsvpcTrunking', value='enabled')\n        send_response(event, context, 'SUCCESS', {'Message': 'ENI trunking enabled successfully'})\n    except Exception as e:\n        error_msg = str(e)\n        print(f'Error: {error_msg}')\n        if 'already' in error_msg.lower() or 'duplicate' in error_msg.lower():\n            send_response(event, context, 'SUCCESS', {'Message': f'ENI trunking setting handled: {error_msg}'})\n        else:\n            send_response(event, context, 'FAILED', {'Error': error_msg})\n",
              {}
            ]
          }
        }
      }
    },
    "EnableENITrunking": {
      "Type": "AWS::CloudFormation::CustomResource",
      "DependsOn": [
        "EnableENITrunkingFunction"
      ],
      "Properties": {
        "ServiceToken": {
          "Fn::GetAtt": [
            "EnableENITrunkingFunction",
            "Arn"
          ]
        }
      }
    },
    "InternalALBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for internal ALB",
        "VpcId": {
          "Ref": "VpcId"
        },
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 80,
            "ToPort": 80,
            "CidrIp": "0.0.0.0/0",
            "Description": "HTTP from VPC (internal ALB, so only accessible within VPC)"
          },
          {
            "IpProtocol": "tcp",
            "FromPort": 443,
            "ToPort": 443,
            "CidrIp": "0.0.0.0/0",
            "Description": "HTTPS from VPC (internal ALB, so only accessible within VPC)"
          }
        ]
      }
    },
    "ALBToECSIngress": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupId": {
          "Ref": "ECSHostSecurityGroup"
        },
        "IpProtocol": "tcp",
        "FromPort": 32768,
        "ToPort": 65535,
        "SourceSecurityGroupId": {
          "Ref": "InternalALBSecurityGroup"
        },
        "Description": "Allow internal ALB to reach ECS tasks on dynamic ports"
      }
    },
    "InternalLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
      "Properties": {
        "Type": "application",
        "Scheme": "internal",
        "IpAddressType": "ipv4",
        "Subnets": [
          {
            "Ref": "PrivateSubnet1Id"
          },
          {
            "Ref": "PrivateSubnet2Id"
          }
        ],
        "SecurityGroups": [
          {
            "Ref": "InternalALBSecurityGroup"
          }
        ]
      }
    },
    "InternalALBDefaultListener": {
      "Type": "AWS::ElasticLoadBalancingV2::Listener",
      "Properties": {
        "LoadBalancerArn": {
          "Ref": "InternalLoadBalancer"
        },
        "Port": 80,
        "Protocol": "HTTP",
        "DefaultActions": [
          {
            "Type": "fixed-response",
            "FixedResponseConfig": {
              "StatusCode": "404",
              "ContentType": "text/plain",
              "MessageBody": "No service found"
            }
          }
        ]
      }
    },
    "CatalogTargetGroup": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "Port": 1024,
        "Protocol": "HTTP",
        "VpcId": {
          "Ref": "VpcId"
        },
        "TargetType": "instance",
        "HealthCheckEnabled": true,
        "HealthCheckPath": "/",
        "HealthCheckProtocol": "HTTP",
        "HealthCheckIntervalSeconds": 30,
        "HealthyThresholdCount": 2,
        "UnhealthyThresholdCount": 3,
        "HealthCheckPort": "traffic-port"
      }
    },
    "CatalogListenerRule": {
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
      "Properties": {
        "ListenerArn": {
          "Ref": "InternalALBDefaultListener"
        },
        "Priority": 100,
        "Conditions": [
          {
            "Field": "path-pattern",
            "PathPatternConfig": {
              "Values": [
                "/catalog/*",
                "/catalog"
              ]
            }
          }
        ],
        "Actions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "CatalogTargetGroup"
            }
          }
        ],
        "Transforms": [
          {
            "Type": "url-rewrite",
            "UrlRewriteConfig": {
              "Rewrites": [
                {
                  "Regex": "^/catalog(/.*)?$",
                  "Replace": "$1"
                }
              ]
            }
          }
        ]
      }
    },
    "UserTargetGroup": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "Port": 1024,
        "Protocol": "HTTP",
        "VpcId": {
          "Ref": "VpcId"
        },
        "TargetType": "instance",
        "HealthCheckEnabled": true,
        "HealthCheckPath": "/",
        "HealthCheckProtocol": "HTTP",
        "HealthCheckIntervalSeconds": 30,
        "HealthyThresholdCount": 2,
        "UnhealthyThresholdCount": 3,
        "HealthCheckPort": "traffic-port"
      }
    },
    "UserListenerRule": {
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
      "Properties": {
        "ListenerArn": {
          "Ref": "InternalALBDefaultListener"
        },
        "Priority": 200,
        "Conditions": [
          {
            "Field": "path-pattern",
            "PathPatternConfig": {
              "Values": [
                "/user/*",
                "/user"
              ]
            }
          }
        ],
        "Actions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "UserTargetGroup"
            }
          }
        ],
        "Transforms": [
          {
            "Type": "url-rewrite",
            "UrlRewriteConfig": {
              "Rewrites": [
                {
                  "Regex": "^/user(/.*)?$",
                  "Replace": "$1"
                }
              ]
            }
          }
        ]
      }
    },
    "PaymentTargetGroup": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "Port": 1024,
        "Protocol": "HTTP",
        "VpcId": {
          "Ref": "VpcId"
        },
        "TargetType": "instance",
        "HealthCheckEnabled": true,
        "HealthCheckPath": "/",
        "HealthCheckProtocol": "HTTP",
        "HealthCheckIntervalSeconds": 30,
        "HealthyThresholdCount": 2,
        "UnhealthyThresholdCount": 3,
        "HealthCheckPort": "traffic-port"
      }
    },
    "PaymentListenerRule": {
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
      "Properties": {
        "ListenerArn": {
          "Ref": "InternalALBDefaultListener"
        },
        "Priority": 300,
        "Conditions": [
          {
            "Field": "path-pattern",
            "PathPatternConfig": {
              "Values": [
                "/payment/*",
                "/payment"
              ]
            }
          }
        ],
        "Actions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "PaymentTargetGroup"
            }
          }
        ],
        "Transforms": [
          {
            "Type": "url-rewrite",
            "UrlRewriteConfig": {
              "Rewrites": [
                {
                  "Regex": "^/payment(/.*)?$",
                  "Replace": "$1"
                }
              ]
            }
          }
        ]
      }
    },
    "Judge0TargetGroup": {
      "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
      "Properties": {
        "Port": 2358,
        "Protocol": "HTTP",
        "VpcId": {
          "Ref": "VpcId"
        },
        "TargetType": "instance",
        "HealthCheckEnabled": true,
        "HealthCheckPath": "/",
        "HealthCheckProtocol": "HTTP",
        "HealthCheckIntervalSeconds": 30,
        "HealthyThresholdCount": 2,
        "UnhealthyThresholdCount": 3,
        "HealthCheckPort": "traffic-port"
      }
    },
    "Judge0ListenerRule": {
      "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
      "Properties": {
        "ListenerArn": {
          "Ref": "InternalALBDefaultListener"
        },
        "Priority": 400,
        "Conditions": [
          {
            "Field": "path-pattern",
            "PathPatternConfig": {
              "Values": [
                "/judge0/*",
                "/judge0"
              ]
            }
          }
        ],
        "Actions": [
          {
            "Type": "forward",
            "TargetGroupArn": {
              "Ref": "Judge0TargetGroup"
            }
          }
        ],
        "Transforms": [
          {
            "Type": "url-rewrite",
            "UrlRewriteConfig": {
              "Rewrites": [
                {
                  "Regex": "^/judge0(/.*)?$",
                  "Replace": "$1"
                }
              ]
            }
          }
        ]
      }
    },
    "ServiceDiscoveryNamespace": {
      "Type": "AWS::ServiceDiscovery::PrivateDnsNamespace",
      "Properties": {
        "Name": "local",
        "Vpc": {
          "Ref": "VpcId"
        },
        "Description": "Private DNS namespace for ECS service discovery"
      }
    },
    "ECSCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterSettings": [
          {
            "Name": "containerInsights",
            "Value": "enabled"
          }
        ]
      }
    },
    "LaunchTemplate": {
      "Type": "AWS::EC2::LaunchTemplate",
      "Properties": {
        "LaunchTemplateData": {
          "ImageId": {
            "Fn::Sub": "{{resolve:ssm:/aws/service/ecs/optimized-ami/amazon-linux-2/recommended/image_id}}"
          },
          "InstanceType": {
            "Ref": "InstanceType"
          },
          "IamInstanceProfile": {
            "Name": {
              "Ref": "ECSInstanceProfile"
            }
          },
          "SecurityGroupIds": [
            {
              "Ref": "ECSHostSecurityGroup"
            }
          ],
          "UserData": {
            "Fn::Base64": {
              "Fn::Sub": "#!/bin/bash -xe\n\nmkdir -p /box\nchmod 1777 /box\nchown root:root /box\n\ncat >/etc/ecs/ecs.config <<'EOF'\nECS_CLUSTER=${ECSCluster}\nEOF\n"
            }
          },
          "MetadataOptions": {
            "HttpEndpoint": "enabled",
            "HttpTokens": "required"
          },
          "BlockDeviceMappings": [
            {
              "DeviceName": "/dev/xvda",
              "Ebs": {
                "VolumeSize": 30,
                "VolumeType": "gp3",
                "DeleteOnTermination": true
              }
            }
          ]
        }
      }
    },
    "AutoScalingGroup": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "DependsOn": [
        "ECSCluster",
        "ECSInstanceRole"
      ],
      "Properties": {
        "VPCZoneIdentifier": [
          {
            "Ref": "PrivateSubnet1Id"
          },
          {
            "Ref": "PrivateSubnet2Id"
          }
        ],
        "LaunchTemplate": {
          "LaunchTemplateId": {
            "Ref": "LaunchTemplate"
          },
          "Version": {
            "Fn::GetAtt": [
              "LaunchTemplate",
              "LatestVersionNumber"
            ]
          }
        },
        "MinSize": {
          "Ref": "MinSize"
        },
        "MaxSize": {
          "Ref": "MaxSize"
        },
        "DesiredCapacity": {
          "Ref": "DesiredCapacity"
        },
        "NewInstancesProtectedFromScaleIn": false,
        "Tags": [
          {
            "Key": "Name",
            "Value": {
              "Fn::Sub": "${AWS::StackName}-ECS-Instance"
            },
            "PropagateAtLaunch": true
          }
        ]
      },
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "MinInstancesInService": 1,
          "MaxBatchSize": 1,
          "PauseTime": "PT1M",
          "WaitOnResourceSignals": false,
          "SuspendProcesses": [
            "AZRebalance",
            "AlarmNotification",
            "HealthCheck",
            "ReplaceUnhealthy",
            "ScheduledActions"
          ]
        }
      }
    },
    "CapacityProvider": {
      "Type": "AWS::ECS::CapacityProvider",
      "Properties": {
        "AutoScalingGroupProvider": {
          "AutoScalingGroupArn": {
            "Ref": "AutoScalingGroup"
          },
          "ManagedScaling": {
            "InstanceWarmupPeriod": 60,
            "MinimumScalingStepSize": 1,
            "MaximumScalingStepSize": 100,
            "Status": "ENABLED",
            "TargetCapacity": 100
          },
          "ManagedTerminationProtection": "DISABLED"
        }
      }
    },
    "CapacityProviderAssociation": {
      "Type": "AWS::ECS::ClusterCapacityProviderAssociations",
      "Properties": {
        "CapacityProviders": [
          {
            "Ref": "CapacityProvider"
          }
        ],
        "Cluster": {
          "Ref": "ECSCluster"
        },
        "DefaultCapacityProviderStrategy": [
          {
            "Base": 0,
            "CapacityProvider": {
              "Ref": "CapacityProvider"
            },
            "Weight": 1
          }
        ]
      }
    },
    "InternalALBHostedZone": {
      "Type": "AWS::Route53::HostedZone",
      "Properties": {
        "Name": "blackprint.local",
        "VPCs": [
          {
            "VPCId": {
              "Ref": "VpcId"
            },
            "VPCRegion": {
              "Ref": "AWS::Region"
            }
          }
        ],
        "HostedZoneConfig": {
          "Comment": "Private hosted zone for internal ALB"
        }
      }
    },
    "InternalALBDnsRecord": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneId": {
          "Ref": "InternalALBHostedZone"
        },
        "Name": "blackprint.local",
        "Type": "A",
        "AliasTarget": {
          "DNSName": {
            "Fn::GetAtt": [
              "InternalLoadBalancer",
              "DNSName"
            ]
          },
          "HostedZoneId": {
            "Fn::GetAtt": [
              "InternalLoadBalancer",
              "CanonicalHostedZoneID"
            ]
          },
          "EvaluateTargetHealth": false
        }
      }
    }
  },
  "Outputs": {
    "VpcId": {
      "Description": "VPC ID",
      "Value": {
        "Ref": "VpcId"
      }
    },
    "ECSClusterName": {
      "Description": "ECS Cluster Name",
      "Value": {
        "Ref": "ECSCluster"
      }
    },
    "CapacityProvider": {
      "Description": "Capacity provider for services to use when placing tasks",
      "Value": {
        "Ref": "CapacityProvider"
      }
    },
    "PrivateSubnet1Id": {
      "Description": "First private subnet for ECS tasks",
      "Value": {
        "Ref": "PrivateSubnet1Id"
      }
    },
    "PrivateSubnet2Id": {
      "Description": "Second private subnet for ECS tasks",
      "Value": {
        "Ref": "PrivateSubnet2Id"
      }
    },
    "ServiceDiscoveryNamespaceId": {
      "Description": "Service Discovery namespace ID",
      "Value": {
        "Ref": "ServiceDiscoveryNamespace"
      }
    },
    "ECSHostSecurityGroupId": {
      "Description": "ECS host security group ID",
      "Value": {
        "Ref": "ECSHostSecurityGroup"
      }
    },
    "InternalLoadBalancerArn": {
      "Description": "Internal ALB ARN",
      "Value": {
        "Ref": "InternalLoadBalancer"
      }
    },
    "InternalLoadBalancerDnsName": {
      "Description": "Internal ALB DNS name",
      "Value": {
        "Fn::GetAtt": [
          "InternalLoadBalancer",
          "DNSName"
        ]
      }
    },
    "InternalALBSecurityGroupId": {
      "Description": "Internal ALB security group ID",
      "Value": {
        "Ref": "InternalALBSecurityGroup"
      }
    },
    "InternalALBListenerArn": {
      "Description": "Internal ALB default listener ARN",
      "Value": {
        "Ref": "InternalALBDefaultListener"
      }
    },
    "CatalogTargetGroupArn": {
      "Description": "Catalog service target group ARN",
      "Value": {
        "Ref": "CatalogTargetGroup"
      }
    },
    "UserTargetGroupArn": {
      "Description": "User service target group ARN",
      "Value": {
        "Ref": "UserTargetGroup"
      }
    },
    "PaymentTargetGroupArn": {
      "Description": "Payment service target group ARN",
      "Value": {
        "Ref": "PaymentTargetGroup"
      }
    },
    "Judge0TargetGroupArn": {
      "Description": "Judge0 service target group ARN",
      "Value": {
        "Ref": "Judge0TargetGroup"
      }
    },
    "InternalALBDomainName": {
      "Description": "Internal ALB domain name",
      "Value": "blackprint.local"
    },
    "InternalALBHostedZoneId": {
      "Description": "Route53 hosted zone ID for internal ALB domain",
      "Value": {
        "Ref": "InternalALBHostedZone"
      }
    }
  }
}